<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Access Terminal</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/html5-qrcode"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
:root {
  --bg: #0f172a;
  --card: #ffffff;
  --accent: #f97316;
  --dark: #111827;
  --radius: 18px;
}

* {
  box-sizing: border-box;
  font-family: system-ui, -apple-system, Segoe UI, Roboto;
}

body {
  margin: 0;
  height: 100vh;
  background: var(--bg);
  display: flex;
}

/* MAIN GRID */
.wrapper {
  display: grid;
  grid-template-columns: 1.5fr 2.5fr 1.25fr;
  width: 100%;
  height: 100%;
}

/* LEFT PANEL */
.left-panel {
  background: #020617;
  display: flex;
  flex-direction: column;
  justify-content: center;
  gap: 30px;
  padding: 40px;
}


.action-btn {
 
  height: 120px;        /* fixed, clean height */
  max-width: 100%;

  border-radius: 20px;
  font-size: 2rem;
  font-weight: 700;
  color: white;
  border: none;
  cursor: pointer;
  transition: 0.2s;
}

.store {
  background: var(--accent);
}

.send {
  background: linear-gradient(135deg, #f97316, #ea580c);
}

.action-btn:hover {
  transform: scale(1.02);
}

/* CENTER PANEL */
.center-panel {
  background: #000000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.display {
  width: 80%;
  height: 60px;
  background: #111827;
  color: white;
  border-radius: 12px;

  margin-bottom: 28px;
  padding: 0 10px;

  font-size: 1.6rem;
  text-align: center;
  line-height: 60px;
  letter-spacing: 4px;
}

.keypad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 18px;
  width: 80%;
  max-width: 360px;
}

.key {
  
  height: 64px;
  border-radius: 16px;
  background: var(--accent);
  font-size: 2rem;
  font-weight: bold;
  border: none;
  cursor: pointer;
  box-shadow: 0 6px 12px rgba(0,0,0,.12);
}

.key:active {
  transform: scale(0.95);
}

.enter {
  grid-column: span 3;
  background: rgb(189, 61, 2);
  color: white;
}

/* RIGHT PANEL */
.right-panel {
  background: linear-gradient(180deg, #111827, #020617);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
 
  font-size: 1.4rem;
  font-weight: 600;
  letter-spacing: 2px;
}



.arrow-box {
  transform: rotate(180deg);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 16px;

}

.arrow {
  font-size: 5rem;
  color: #facc15;
  animation: slide 1.2s infinite ease-in-out;
}

.arrow-box span {
  color: #facc15;
  font-weight: 600;
  letter-spacing: 2px;
  font-size: 1rem;
}

/* Arrow movement */
@keyframes slide {
  0%   { transform: translateX(0); opacity: 0.4; }
  50%  { transform: translateX(-15px); opacity: 1; }
  100% { transform: translateX(0); opacity: 0.4; }
}

/* Soft pulse */
@keyframes pulse {
  0% { opacity: 0.7; }
  50% { opacity: 1; }
  100% { opacity: 0.7; }
}
.center-panel {
  background: #020617;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 18px;
  padding: 20px;
  height: 100%;
}

.center-panel img {
  margin-bottom: 10px;
}
.center-panel h1 {
  margin: 0 0 18px;
  font-size: 1.6rem;
  letter-spacing: 1px;
}
html, body {
  height: 100%;
  overflow: hidden;
}

/* Main wrapper fix */
.wrapper {
  height: 100vh;
  width: 100vw;
}

/* Auto scale everything */
@media (max-height: 800px) {
  .wrapper {
    transform: scale(0.9);
    transform-origin: center;
  }
}

@media (max-height: 700px) {
  .wrapper {
    transform: scale(0.85);
  }
}

@media (max-height: 600px) {
  .wrapper {
    transform: scale(0.78);
  }
}

</style>
<style>
      .modal-content {
      background: #111;
      color: #ffae42;
      border: 2px solid #ff6600;
      box-shadow: 0 0 25px rgba(255, 102, 0, 0.8);
    }
.alert {
      background: #111;
      border: 1px solid #ff6600;
      color: #ffae42;
      box-shadow: 0 0 12px rgba(255, 102, 0, 0.4);
    }

    /* 3D Locker */
    .locker-scene {
      perspective: 800px;
      margin: 0 auto;
      width: 220px;
      height: 160px;
    }

    .locker {
      position: relative;
      width: 220px;
      height: 160px;
      margin: 0 auto;
      transform-style: preserve-3d;
      transform: rotateY(-12deg) rotateX(5deg);
    }

    .locker .box {
      position: absolute;
      inset: 0;
      transform-style: preserve-3d;
    }

    .panel {
      position: absolute;
      background: #1f1f1f;
      border: 2px solid #ff6600;
      box-shadow: inset -6px -6px 12px rgba(255, 102, 0, 0.2), 0 0 10px rgba(255, 102, 0, 0.4);
    }

    .panel.back {
      width: 220px;
      height: 160px;
      transform: translateZ(-60px);
    }

    .panel.bottom {
      width: 220px;
      height: 120px;
      transform: rotateX(-90deg) translateZ(60px);
      transform-origin: top;
    }

    .panel.top {
      width: 220px;
      height: 120px;
      transform: rotateX(90deg) translateZ(100px);
      transform-origin: bottom;
    }

    .panel.left {
      width: 120px;
      height: 160px;
      transform: rotateY(90deg) translateZ(110px);
      transform-origin: left;
    }

    .panel.right {
      width: 120px;
      height: 160px;
      transform: rotateY(-90deg) translateZ(110px);
      transform-origin: right;
    }

    /* Door */
    .door {
      position: absolute;
      width: 220px;
      height: 160px;
      transform-origin: left center;
      transform: rotateY(0deg) translateZ(60px);
      background: linear-gradient(145deg, #2b1a00, #1a0e00);
      border: 2px solid #ff6600;
      border-left-width: 6px;
      box-shadow: inset -6px -6px 12px rgba(255, 102, 0, 0.2), 0 0 20px rgba(255, 102, 0, 0.5);
    }

    .door::after {
      content: "";
      position: absolute;
      right: 18px;
      top: 70px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #ffae42;
      box-shadow: 0 0 10px #ff6600 inset, 0 0 10px #ff6600;
    }

    .door .mesh-window {
      position: absolute;
      left: 18px;
      right: 18px;
      top: 16px;
      bottom: 16px;
      background: repeating-linear-gradient(45deg, rgba(255, 102, 0, 0.25), rgba(255, 102, 0, 0.25) 2px, transparent 2px, transparent 4px),
        repeating-linear-gradient(-45deg, rgba(255, 102, 0, 0.25), rgba(255, 102, 0, 0.25) 2px, transparent 2px, transparent 4px);
      border: 1px solid rgba(255, 102, 0, 0.5);
      border-radius: 3px;
      box-shadow: inset 0 0 6px rgba(255, 102, 0, 0.5);
    }

    .open .door {
      animation: door-open 1.2s ease forwards;
    }

    @keyframes door-open {
      to {
        transform: rotateY(-105deg) translateZ(60px);
      }
    }

    /* Floating */
    .floaty {
      animation: floaty 3s ease-in-out infinite;
    }

    @keyframes floaty {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-6px);
      }
    }
    /* RIGHT PANEL QR */
.right-panel {
  background: linear-gradient(180deg, #111827, #020617);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 30px;
}

.qr-wrapper {
  width: 100%;
  max-width: 320px;
  text-align: center;
}

.qr-title {
  font-size: 1.4rem;
  font-weight: 700;
  letter-spacing: 2px;
  margin-bottom: 12px;
  color: #facc15;
}

.qr-box {
  width: 100%;
  height: 280px;
  border-radius: 16px;
  background: #000;
  border: 2px dashed #f97316;
  
}
/* Hide html5-qrcode default controls */
#qr-reader__dashboard {
  display: none !important;
}
#qr-reader video {
  border-radius: 14px;
  object-fit: cover;
  height: 280px;
}

.qr-status {
  font-size: 0.9rem;
  color: #cbd5f5;
  margin-top: 6px;
}

.qr-hint {
  margin-top: 12px;
  font-size: 0.85rem;
  color: #facc15;
  opacity: 0.9;
}

</style>

    <style>
    :root {
      --accent: #ff7b00;
      --dark: #0f172a;
      --card: #ffffff;
      --muted: #6b7280;
      --radius: 18px;
    }

   
   

    /* HEADER */
    .header {
      height: 80px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      border-bottom: 1px solid #eee;
    }

    .header h1 {
      font-size: 22px;
      font-weight: 800;
      margin: 0;
    }

    .back-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 10px;
      font-weight: 700;
    }

    /* MAIN */
    .screen {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .panel {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0,0,0,.1);
      padding: 30px;
      width: 100%;
      max-width: 520px;
      text-align: center;
    }

    .panel img {
      height: 70px;
      margin-bottom: 10px;
    }

    .panel h3 {
      font-weight: 800;
      margin-bottom: 14px;
    }

    .code-input {
      width: 50%;
      font-size: 34px;
      letter-spacing: 10px;
      text-align: center;
      border: none;
      background-color: linear-gradient(180deg, #111827, #020617);
      margin-bottom: 20px;
      color: white;
      padding: 8px 0;
      outline: none;
      font-weight: 700;
    }

    /* KEYPAD */
    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 14px;
      margin-bottom: 20px;
    }

    .key {
      height: 70px;
      border-radius: 14px;
      background: var(--accent);
      border: none;
      font-size: 24px;
      font-weight: 800;
      color: white;
      box-shadow: 0 6px 16px rgba(0,0,0,.2);
    }

    .key:active {
      transform: scale(.96);
    }

    .submit-btn {
      width: 50%;
      padding: 14px;
      font-size: 18px;
      font-weight: 800;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 14px;
      margin-top: 10px;
    }

    .secondary-btn {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 12px;
      background: #f3f4f6;
      border: none;
      font-weight: 600;
    }

    /* MODAL */
    .modal-content {
      border-radius: 20px;
      text-align: center;
      padding: 20px;
    }

    .payment-icon {
      width: 80px;
      height: 80px;
      margin: auto;
      border-radius: 50%;
      background: linear-gradient(135deg,#ff7b00,#ff9f43);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 36px;
      margin-bottom: 15px;
    }
</style>
</head>

<body>

<div class="wrapper">

  <!-- LEFT -->
  <div class="left-panel">
    <button class="action-btn store" onclick="window.location.href='/terminal/phone'">STORE</button>
    <button class="action-btn send">SEND</button>
  </div>

  <!-- CENTER -->
  <div class="center-panel" style="background-color: #020617;">
  <img src="images/droppointlogo.png" style="height:120px; max-width:100%;" />

    <h1 style="color: white; ">ENTER DROP / PICKUP CODE</h1>
    <input id="accessCode" class="code-input" maxlength="6" readonly style="background-color: rgb(0, 0, 0);"/>

    <div class="keypad">
      <button class="key" onclick="pressKey(1)">1</button>
      <button class="key" onclick="pressKey(2)">2</button>
      <button class="key" onclick="pressKey(3)">3</button>
      <button class="key" onclick="pressKey(4)">4</button>
      <button class="key" onclick="pressKey(5)">5</button>
      <button class="key" onclick="pressKey(6)">6</button>
      <button class="key" onclick="pressKey(7)">7</button>
      <button class="key" onclick="pressKey(8)">8</button>
      <button class="key" onclick="pressKey(9)">9</button>
      <button class="key" onclick="clearCode()">C</button>
      <button class="key" onclick="pressKey(0)">0</button>
      <button class="key" onclick="deleteKey()">âŒ«</button>
    </div>

    <button class="submit-btn" onclick="submitCode()">Unlock</button>
    
   
  </div>

  <!-- RIGHT -->
<!-- RIGHT PANEL -->
<div class="right-panel">
  <div class="qr-wrapper">
    <div class="qr-title">SCAN QR CODE</div>

    <!-- Camera / USB QR -->
    <div id="qr-reader" class="qr-box"></div>
  <input id="usb-qr-input" type="text" autocomplete="off" inputmode="none"
              style="opacity:0; position:absolute; left:-9999px; width:0; height:0;" />
    <div id="qr-status" class="qr-status">
      Initializing scannerâ€¦
    </div>

    
  </div>
</div>


</div>







 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>

<script>
  function pressKey(num) {
    const input = document.getElementById("accessCode");
    if (input.value.length < 6) {
      input.value += num;
    }
  }

  function deleteKey() {
    const input = document.getElementById("accessCode");
    input.value = input.value.slice(0, -1);
  }

  function clearCode() {
    document.getElementById("accessCode").value = "";
  }

  function submitCode() {
    const code = document.getElementById("accessCode").value.trim();

    if (code.length !== 6) {
      alert("Please enter 6 digit code");
      return;
    }

    console.log("Entered code:", code);
    // Your API call here
  }
</script>


  <script>
    function goBack() { window.location.href = '/'; }

    document.addEventListener("DOMContentLoaded", () => {
      const statusEl = document.getElementById("qr-status");
      const lockerId = "<%= lockerId %>";

      // fallback container for USB scanner message
      const qrReader = document.getElementById("qr-reader");

      Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
          // âœ… Camera available â†’ start scanner
          const scanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 230 }, false);

          window.restartScanner = (msg = null) => {
            if (msg) {
              statusEl.textContent = `âš ï¸ ${msg}`;
              statusEl.className = "mt-2 small text-warning";
            }
            Promise.resolve()
              .then(() => scanner.clear())
              .catch(() => { })
              .finally(() => {
                statusEl.textContent = "Scanner ready. Show QR code.";
                statusEl.className = "mt-2 small text-muted";
                scanner.render(onScanSuccess);
              });
          };

          function handleApi(accessCode) {
            statusEl.textContent = "Processing QR codeâ€¦";
            statusEl.className = "mt-2 small text-primary";
            return fetch('/api/locker/scan', {
              method: 'POST',
              headers: { 'Content-Type': 'text/plain' },
              body: `${accessCode}///${lockerId}`
            })
              .then(res => res.json().then(data => ({ ok: res.ok, data, status: res.status })))
              .then(({ ok, data, status }) => {
                if (data && data.paymentRequired && data.paymentPage) {
                  // Optional small delay so alert is visible on kiosk
                  alert(data.message || 'Payment required to unlock locker');
                  window.location.href = data.paymentPage;
                  return null; // stop further handling
                }
                if (!ok || !data.success) {
                  if (data.message && data.message.includes("already been picked")) {
                    new bootstrap.Modal(document.getElementById('parcelModal')).show();
                  } else if (data.message && data.message.includes("No available compartments")) {
                    new bootstrap.Modal(document.getElementById('noCompartmentModal')).show();
                  } else {
                    throw new Error(data.message || `Request failed (${status})`);
                  }
                  return;
                }
                if (data && data.success && data.compartmentId) {
                  const status = data.parcelStatus || "";
                  if (status === "picked") {
                    new bootstrap.Modal(document.getElementById('parcelModal')).show();
                  } else if (status === "awaiting_drop") {
                    showAssignedModal(data.compartmentId, "awaiting_drop");
                  } else if (status === "awaiting_pick") {
                    showAssignedModal(data.compartmentId, "awaiting_pick");
                  } else {
                    showAssignedModal(data.compartmentId);
                  }
                }
              });
          }

          function onScanSuccess(decodedText) {
            const accessCode = (decodedText || '').trim();
            if (!accessCode) {
              window.restartScanner("Invalid QR format");
              return;
            }
            scanner.clear().catch(() => { }).finally(() => {
              handleApi(accessCode)
                .catch(err => {
                  console.error('API Error:', err);
                  statusEl.textContent = err.message || "Network error";
                  statusEl.className = "mt-2 small text-warning";
                })
                .finally(() => {
                  window.restartScanner();
                  setTimeout(() => window.location.reload(), 5000);
                });
            });
          }

          scanner.render(onScanSuccess);
          statusEl.textContent = "Scanner ready. Show QR code.";
          statusEl.className = "mt-2 small text-muted";

        } else {
          // ðŸš¨ No camera â†’ fallback UI
          qrReader.innerHTML = `
          <div class="d-flex flex-column align-items-center justify-content-center p-4">
            <i class="fa-solid fa-barcode fa-4x mb-3" style="color:#ff6600;"></i>
            <h5 class="text-warning">Scan your QR code</h5>
            <p class="small text-muted">Use the USB QR reader to authenticate</p>
          </div>
        `;
          statusEl.textContent = "USB QR Reader Mode";
          statusEl.className = "mt-2 small text-info";
        }
      }).catch(err => {
        console.error("Camera check failed:", err);
        qrReader.innerHTML = `
        <div class="d-flex flex-column align-items-center justify-content-center p-4">
          <i class="fa-solid fa-barcode fa-4x mb-3" style="color:#ff6600;"></i>
          <h5 class="text-warning">Scan your QR code</h5>
          <p class="small text-muted">Use the USB QR reader to authenticate</p>
        </div>
      `;
        statusEl.textContent = "USB QR Reader Mode";
        statusEl.className = "mt-2 small text-info";
      });
    });
  </script>


  <script>
    // make it global so both camera + USB can use it
    function showAssignedModal(compartmentId, parcelStatus) {
      document.getElementById("assignedLockerId").textContent = compartmentId;
      const actionText = document.getElementById("lockerActionText");
      const subNote = document.getElementById("lockerSubNote");

      if (parcelStatus === "awaiting_drop") {
        actionText.textContent = "Please drop your parcel inside the locker";
        subNote.textContent = "Door will open for dropping";
      } else if (parcelStatus === "awaiting_pick") {
        actionText.textContent = "Please pick up your parcel";
        subNote.textContent = "Door will open for collection";
      } else {
        actionText.textContent = "Proceed to your locker";
        subNote.textContent = "Door will open automatically";
      }

      const modalEl = document.getElementById('lockerAssignedModal');
      const locker3D = document.getElementById('locker3D');
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
      setTimeout(() => locker3D.classList.add('open'), 600);
      setTimeout(() => { modal.hide(); }, 5000);

      modalEl.addEventListener('hidden.bs.modal', () => {
        locker3D.classList.remove('open');
      }, { once: true });
    }
  </script>

  <!-- âœ… USB QR READER HANDLER (improved & hardened) -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('usb-qr-input');
      const accessOut = document.getElementById('usb-access-code');
      const lockerId = "<%= lockerId %>";
      const statusEl = document.getElementById('qr-status');

      // ---- Config ----
      const EXPECT_LEN = 6;               // set to null if variable length
      const FALLBACK_DEBOUNCE_MS = 120;   // when no Enter is sent
      const COOLDOWN_MS = 600;            // ignore keystrokes immediately after a scan
      const MIN_PROCESS_INTERVAL_MS = 800; // minimum time between processed scans
      const DUPLICATE_WINDOW_MS = 2500;   // ignore identical codes scanned within this window

      // ---- State ----
      let scanBufferTimeout = null;
      let isCooldown = false;
      let isProcessing = false;
      let lastProcessedTime = 0;
      let lastProcessedValue = null;
      let focusInterval = null;

      // ---- helpers ----
      function focusHidden() {
        try {
          input.focus();
        } catch (e) { /* ignore */ }
      }

      // focus periodically so USB keyboards send to hidden input; stop on page hide/unload
      focusHidden();
      focusInterval = setInterval(focusHidden, 3000);

      function cleanupOnUnload() {
        if (focusInterval) {
          clearInterval(focusInterval);
          focusInterval = null;
        }
        if (scanBufferTimeout) {
          clearTimeout(scanBufferTimeout);
          scanBufferTimeout = null;
        }
      }
      window.addEventListener('beforeunload', cleanupOnUnload);
      window.addEventListener('pagehide', cleanupOnUnload);

      function now() { return Date.now(); }

      // Normalize duplicates like "123456123456" -> "123456"
      function dedupeIfRepeated(s) {
        if (!EXPECT_LEN) return s;
        if (s.length === EXPECT_LEN * 2 && s.slice(0, EXPECT_LEN) === s.slice(EXPECT_LEN)) {
          return s.slice(0, EXPECT_LEN);
        }
        return s;
      }

      function sanitize(raw) {
        // remove whitespace/newlines and non-printables
        return (raw || '').replace(/[\r\n\s]+/g, '').trim();
      }

      function extractAccessCode(raw) {
        const first = String(raw || '').split('///')[0];
        let s = sanitize(first);
        s = dedupeIfRepeated(s);
        return s;
      }

      function setCooldown() {
        isCooldown = true;
        setTimeout(() => { isCooldown = false; }, COOLDOWN_MS);
      }

      // Main scan handler â€” ensures single processing at a time and duplicates/rate-limit
      async function handleScan(rawSnapshot) {
        if (!rawSnapshot) return;
        const code = extractAccessCode(rawSnapshot);
        if (!code) return;

        const t = now();
        // duplicate / rapid protection
        if (lastProcessedValue === code && (t - lastProcessedTime) < DUPLICATE_WINDOW_MS) {
          // ignore repeated identical scan
          console.debug('Ignored duplicate scan', code);
          return;
        }
        if ((t - lastProcessedTime) < MIN_PROCESS_INTERVAL_MS) {
          // too fast between different scans
          console.debug('Ignored rapid scan', code);
          return;
        }

        if (isCooldown || isProcessing) {
          console.debug('Busy, skipping scan', { isCooldown, isProcessing, code });
          return;
        }

        // update UI immediately
        accessOut.textContent = code || 'â€”';
        statusEl.textContent = "Processing QR codeâ€¦";
        statusEl.className = "mt-2 small text-primary";

        isProcessing = true;
        setCooldown();

        try {
          const res = await fetch('/api/locker/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain' },
            body: `${code}///${lockerId}`
          });

          const payload = await res.json().catch(() => ({}));
          if (!res.ok) {
            const msg = (payload && payload.message) ? payload.message : `Request failed (${res.status})`;
            throw new Error(msg);
          }
          if (payload && payload.paymentRequired && payload.paymentPage) {
            // Optional small delay so alert is visible on kiosk
            alert(payload.message || 'Payment required to unlock locker');
            window.location.href = payload.paymentPage;
            return null; // stop further handling
          }
          // success handling
          if (payload && payload.success && payload.compartmentId) {
            const status = payload.parcelStatus || "";   // âœ… use parcelStatus
            if (status === "picked") {
              new bootstrap.Modal(document.getElementById('parcelModal')).show();
            } else if (status === "awaiting_drop") {
              showAssignedModal(payload.compartmentId, "awaiting_drop");
            } else if (status === "awaiting_pick") {
              showAssignedModal(payload.compartmentId, "awaiting_pick");
            } else {
              showAssignedModal(payload.compartmentId);
            }
            setTimeout(() => { window.location.reload(); }, 2000);


            // remember this processed scan
            lastProcessedTime = now();
            lastProcessedValue = code;
          } else {
            throw new Error((payload && payload.message) ? payload.message : "Scan failed");
          }
        } catch (err) {
          console.error('USB API Error:', err);
          statusEl.textContent = err.message || "Network error";
          statusEl.className = "mt-2 small text-warning";
        } finally {
          isProcessing = false;
          // restart camera scanner if available
          if (window.restartScanner) {
            try { window.restartScanner(); } catch (e) { /* ignore */ }
          }
          // double-clear just in case hardware keeps typing
          input.value = '';
          focusHidden();
        }
      }

      // Handle Enter key (most hardware sends it) â€” snapshot + immediate process
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          if (scanBufferTimeout) {
            clearTimeout(scanBufferTimeout);
            scanBufferTimeout = null;
          }
          const snap = input.value;
          input.value = '';
          handleScan(snap);
        }
      });

      // Fallback for scanners that don't send Enter â€” debounce
      input.addEventListener('input', () => {
        if (isCooldown || isProcessing) return;
        if (scanBufferTimeout) {
          clearTimeout(scanBufferTimeout);
          scanBufferTimeout = null;
        }

        const snap = input.value;
        // If we have EXPECT_LEN and got that many characters â€” process ASAP
        const maybe = extractAccessCode(snap);
        if (EXPECT_LEN && maybe.length >= EXPECT_LEN) {
          // process immediately (but keep protections inside handleScan)
          // capture current full buffer (not just maybe) because some scanners send suffixes
          const capture = snap;
          input.value = ''; // clear to avoid concat with next scan
          handleScan(capture);
          return;
        }

        // Otherwise debounce a bit to wait for more keystrokes
        scanBufferTimeout = setTimeout(() => {
          const finalSnap = input.value;
          // if nothing meaningful, do nothing
          const finalMaybe = extractAccessCode(finalSnap);
          if (!finalMaybe) {
            input.value = '';
            return;
          }
          input.value = '';
          handleScan(finalSnap);
        }, FALLBACK_DEBOUNCE_MS);
      });

      // Support paste (some scanners / debug flows paste)
      input.addEventListener('paste', (e) => {
        const pasted = (e.clipboardData && e.clipboardData.getData) ? e.clipboardData.getData('text') : '';
        if (pasted) {
          // process pasted content immediately
          e.preventDefault();
          input.value = '';
          handleScan(pasted);
        }
      });

    });
  </script>
  <script>
    (function () {
      let timer;

      function resetTimer() {
        clearTimeout(timer);
        timer = setTimeout(() => {
          window.location.href = '/';
        }, 20000); // 20 seconds
      }

      // Reset on any user activity
      ['mousemove', 'click', 'touchstart'].forEach(evt =>
        document.addEventListener(evt, resetTimer)
      );

      // Start immediately
      resetTimer();
    })();
  </script>
  <script>
function pressKey(n){
  const i = document.getElementById("accessCode");
  if(i.value.length < 6) i.value += n;
}
function deleteKey(){
  const i = document.getElementById("accessCode");
  i.value = i.value.slice(0,-1);
}
function clearCode(){
  document.getElementById("accessCode").value = "";
}
function goBack(){
  window.location.href = "/";
}
function submitCode(){
  alert("Connect your API here");
}





function showPaymentRequiredModal(message, paymentPage) {
  document.getElementById('paymentMessage').textContent =
    "Please pay the due to unlock your locker"

  const payBtn = document.getElementById('payNowBtn');
  payBtn.onclick = () => window.location.href = paymentPage;

  bootstrap.Modal.getOrCreateInstance(
    document.getElementById('paymentRequiredModal')
  ).show();
}


    function goBack() { window.location.href = '/'; }


  function showAssignedModal(compartmentId, parcelStatus){
    const modalEl = document.getElementById('lockerAssignedModal');
    if(modalEl.parentElement !== document.body){ document.body.appendChild(modalEl); }

    document.getElementById('assignedLockerId').textContent = 'C' + compartmentId;
    const actionText = document.getElementById('lockerActionText');
    const subNote = document.getElementById('lockerSubNote');
    const closeWarn = document.getElementById('closeWarning');

    if(parcelStatus === 'awaiting_drop'){
      actionText.textContent = 'Please drop your parcel inside the locker';
      subNote.textContent = 'Door will open for dropping';
      if(closeWarn) closeWarn.textContent = 'AFTER DROPPING, CLOSE THE LOCKER FIRMLY';
    } else if(parcelStatus === 'awaiting_pick'){
      actionText.textContent = 'Please pick up your parcel';
      subNote.textContent = 'Door will open for collection';
      if(closeWarn) closeWarn.textContent = 'AFTER PICKUP, CLOSE THE LOCKER FIRMLY';
    } else {
      actionText.textContent = 'Proceed to your locker';
      subNote.textContent = 'Door will open automatically';
      if(closeWarn) closeWarn.textContent = 'CLOSE THE LOCKER FIRMLY AFTER YOUâ€™RE DONE';
    }

    // Reset listeners and show
    modalEl.replaceWith(modalEl.cloneNode(true));
    const freshModalEl = document.getElementById('lockerAssignedModal');
    const modal = bootstrap.Modal.getOrCreateInstance(freshModalEl);
    modal.show();

    // Auto close after 5s
    setTimeout(() => modal.hide(), 5000);
  }



    function pressKey(num) {
      const input = document.getElementById('accessCode');
      if (input.value.length >= 6) return;
      input.value = (input.value + String(num)).slice(0, 6);
    }
    function deleteKey() { const i = document.getElementById('accessCode'); i.value = i.value.slice(0, -1); }
    function clearCode() { document.getElementById('accessCode').value = ''; }


function submitCode() {
  const code = document.getElementById('accessCode').value.trim();
  if (code.length !== 6) {
    alert('Please enter your 6-digit code');
    return;
  }

  fetch('/api/locker/unlock-code', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ accessCode: code, lockerId: 'L00002' })
  })
  .then(async res => {
    const data = await res.json().catch(() => ({}));

    // ðŸ”´ PAYMENT REQUIRED â†’ ALWAYS REDIRECT
    if (data && data.paymentRequired && data.paymentPage) {
      // Optional small delay so alert is visible on kiosk
if (data && data.paymentRequired && data.paymentPage) {
  showPaymentRequiredModal(data.message, data.paymentPage);
  return null;
}


      window.location.href = data.paymentPage;
      return null; // stop further handling
    }

    // âŒ Other non-success cases
    if (!res.ok) {
      throw new Error(data.message || `Request failed (${res.status})`);
    }

    return data;
  })
  .then(data => {
    if (!data) return;

    // âœ… SUCCESS â†’ UNLOCKED
    if (data.success && data.compartmentId) {
      showAssignedModal(data.compartmentId, data.parcelStatus);
      clearCode();
    } else {
      alert(data.message || 'Something went wrong');
    }
  })
  .catch(err => {
    console.error(err);
    alert(err.message || 'Error verifying code');
  });
}



  </script>
  <!-- Parcel Already Picked Modal -->
  <div class="modal fade" id="parcelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content"
        style="background:#1a1a1a; color:white; border-radius:12px; text-align:center; box-shadow:0 0 25px rgba(255,140,0,0.8);">
        <div class="modal-body p-4">
          <i class="fa-solid fa-box-open fa-3x mb-3" style="color:#ff6600;"></i>
          <h4>Parcel Already Picked</h4>
          <p class="mt-2">This parcel has already been collected earlier.</p>
          <button class="btn btn-warning mt-3" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Locker Assigned Modal -->
  <div class="modal fade" id="lockerAssignedModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-header border-0">
          <h5 class="modal-title w-100"><i class="bi bi-box-seam-fill text-success me-2"></i> Locker Assigned</h5>
        </div>
        <div class="modal-body">
          <div class="floaty">
            <h1 id="assignedLockerId" class="display-3 fw-bold text-warning">--</h1>
            <p id="lockerActionText" class="text-muted mb-3">Proceed to your locker</p>
            <div class="locker-scene mt-2">
              <div id="locker3D" class="locker">
                <div class="box">
                  <div class="panel back"></div>
                  <div class="panel bottom"></div>
                  <div class="panel top"></div>
                  <div class="panel left"></div>
                  <div class="panel right"></div>
                  <div class="door">
                    <div class="mesh-window"></div>
                  </div>
                </div>
              </div>
            </div>
            <div id="lockerSubNote" class="mt-3 small text-muted">Door will open automatically</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- No Compartment Available Modal -->
  <div class="modal fade" id="noCompartmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4"
        style="background:#1a1a1a; color:white; border-radius:12px; box-shadow:0 0 25px rgba(255,0,0,0.8);">
        <div class="modal-body">
          <i class="fa-solid fa-triangle-exclamation fa-3x mb-3" style="color:#ff3333;"></i>
          <h4>No Compartment Available</h4>
          <p class="mt-2">No locker is available for this parcel size.</p>
          <button class="btn btn-danger mt-3" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
